\chapter{接口使用规约描述语言研究}
\label{cha:impsec}
随着软件规模和复杂度的提升与开源社区的蓬勃发展，
开发者经常利用现有的应用编程接口（API）来快速构建系统。
在使用API时完成特定功能时，
需要满足对应的约束条件，
例如：检查参数的有效性，正确的调用序列等等。
违反这些约束中的一条或多条，
则会产生接口误用（API misuse），
导致程序缺陷、系统崩溃，甚至被攻击者利用。
如何对接口使用规约进行描述，
是避免接口误用的前提条件。
接口行为规约描述语言（BISL）提供了面向代码层次的形式化描述，
能够有效的帮助程序员理解API的行为以及使用条件。
因此，针对接口误用的缺陷特点，
通过领域特定规约描述语言能够有效的定义接口使用约束。


本章首先针对不同领域的开源C程序中的接口缺陷实例进行分析，
总结接口缺陷常见模式。
接着基于缺陷模式，提出轻量级接口使用规约描述语言IMSpec，
描述了该语言的设计动机，定义了该语言的语法结构和语义信息。
本章将IMSpec应用于调研中收集的接口缺陷实例，以验证语言的有效性。
从全文的研究体系上看，本章的工作旨在通过形式化的方法对接口使用约束条件描述
是接口缺陷检测工作的重要基础。


\section{引言}
开发者在使用API构造软件系统时，
需要满足特定的使用约束条件以正确的完成相应的功能。
例如：API参数为指针类型是，该指针不可以为空，
否则产生一个空指针错误；
当通过内存申请API获得内存资源后，需要使用相应的释放API以规约资源，
否则产生一个内存泄漏错误。
这些由于误用API产生的缺陷是软件缺陷、系统崩溃的重要原因之一，
甚至会被攻击者利用，带来巨大影响。


为了保证API的正确使用，
一方面，API的设计者提供了各种各样的文档、应用案例，
以帮助使用者理解API的功能和对应的使用约束条件，
然而，现在的文档形式难以保证API被正确使用~\cite{09-icse-doc}。
更严重的是，随着开源软件的蓬勃发展，
大量的库函数没有完整的文档资料，
甚至没有或者存在错误的使用说明~\cite{15-ieee-doc-fail, 17-icse-api-doc}。
相对于直接查找官方的API使用文档，
更多的使用者通过网络搜索来快速的找到相应的使用方法。
另一方面，研究人员通过缺陷检测的方法对API误用进行查找，
以提高代码质量。
然而现有的检测方法难以满足实际需求。
（1）基于静态分析技术的检测工具，
多通过预先实现的检测器来进行缺陷查找~\cite{15-coufless-static-survey}。
因此，该方法难以找到为定义的API缺陷。
（2）基于数据挖掘技术的方法，通过推理API使用规约，
再基于规约来进行缺陷检测。
然而，现有的数据集质量难以满足学习算法的数据要求~\cite{survey18}。
无论是API的设计人员还是缺陷检测的研究人员，
如何有效的定义API使用规约是保证接口正确使用的基础。

BISL提供了面向代码层次的形式化描述，
能够有效的帮助程序员理解API的行为以及使用条件~\cite{survey12}。
通俗来说，这些规约描述为接口的开发者和使用者提供了一种形式化的契约模式(software contract)~\cite{92-ieee-contract}。
这些规约描述通过形式化的方法，
指令为能够获得正确的结果，
API在使用时需要满足的特定的约定（convention）。
然而，针对于API使用约束的描述，
现有的BISL具有若干不足。
（1）现有的普适性程序特征的BISL多基于接口的实现而设计，
即有利于描述API的内部属性。
随着软件的规模和复杂性增加，API的使用情景复杂化。
普适性的BISL难以方便的描述API使用的约束条件。
（2）现有的针对接口使用的BISL往往只关注某个特定的领域，
语义的表达能力不足，难以应用到普适性的API使用。
例如：SLIC~\cite{01-slic}针对于Windows驱动程序设计，
SSLINT~\cite{15-sp-sslint}针对于SSL的若干API设计。


为解决上述方法中的不足，本章提出IMSpec领域特定语言（DSL），
一个基于缺陷模式的C程序接口使用规约描述语言。
首先，为能够深入理解C程序接口误用缺陷的特点，
本章以不同领域、广泛使用的六个开源软件为对象，
对近五年来830实际API误用实例进行分析，
总结出三大类常见接口缺陷模式。
即不正确的参数使用（Improper Parameter Using, IPU）、
不正确的异常处理（Improper Error Handling, IEH）、
不正确的因果调用关系（Improper Causal Calling, ICC）。
这些缺陷模式一方面可以为规约描述语言的设计提供基础，
简化语言的复杂度与针对性。
另一方面，有利于辅助研究人员和开发者理解实际项目中的缺陷模式，
以设计和避免接口误用缺陷。
基于缺陷模式，本章提出领域特定语言IMSpec，
以描述针对C程序接口使用的规约条件。
本章对IMSpec的设计原则、语法结构与形式化语义进行详细描述。
最后，本章将IMSpec应用于调研中发现的典型缺陷实例，
以展示该语言的有效性。


本章其余部分组织结构如下：
\ref{sec:2.2}节对相关研究进行总结；
\ref{sec:2.3}给出针对接口缺陷的调研方法与结果；
\ref{sec:2.4}给出IMSpec的设计思路、语法与语义，以及应用实例；
最后在\ref{sec:2.5}总结本章工作。

\section{相关工作}
\label{sec:2.2}
与本章相关的研究包括两个方面：
接口使用的调研工作与规约描述语言的设计工作。
本节将分别对这两个内容的相关总做进行总结。

\paragraph{接口使用调研}
过去的二十年内，研究人员针对于接口使用从不同的角度开展了大量的调研工作
~\cite{16-icse-cry,17-tse-survey, 12-fse-parallel,12-fse-deprecation,
	18-sqj-evolution,11-etaps-doc, 15-ese-evolution, 11-ese-learning, 15-tse-change,13-etaps-mapping}。
一方面，研究人员从API本身入手，对API文档~\cite{12-fse-deprecation, 18-sqj-evolution,11-etaps-doc}、
API演化~\cite{15-ese-evolution,15-tse-change}等进行分析；
另一方面，则从使用者的角度，对API使用中的问题进行分析~\cite{16-icse-cry,17-tse-survey,12-fse-parallel,11-ese-learning,13-etaps-mapping}。

随着软件库的更新，新的API用来替换有问题的API，
以增加稳定性、提升效率。
使用这些过期的API，则导致API误用。
Robbes~\cite{12-fse-deprecation, 18-sqj-evolution}针对使用过期API带来的影响，
在超过2600个系统中分析了577个不同的API。
其结果显示，虽然只有14\%的API在升级后会影响其他的系统，
然而这些改变会带来极大地影响。
其中最多的能够涉及到80个开发者，120个项目。
然而，很多开发者对此并没有作出相应的应对措施，
降低系统的可靠性。

从使用的角度，Zhong~\cite{17-tse-survey}针对于不同类型的API的使用情况进行了调研分析，
总结出9个与API使用相关的发现，
以改进、设计更好的规约挖掘技术。
特别地，该论文指出，在对API的使用进行规约描述时，
需要考虑非顺序调用关系、类型信息、顺序关系三个特点。
随着多核处理器的发展，开发人开始利用并行化技术来加快问题求解。

Okur~\cite{12-fse-parallel}对655个开源项目中并行计算库中的API使用情况进行分析。
结果显示，超过10\%的开发者误用了这些API，导致程序并没有并行化运行，而是在串行执行。
同时，由于对API使用规则的生疏，开发者撰写的代码复杂度，难以理解与维护。

与Okur的工作类似，Nadi~\cite{16-icse-cry}针对加密算法的API使用情况进行了分析。
该研究针对100个StackOverflow的问题与回答讨论、100个Github上的开源项目和48个实际开发者进行调研。
其结果显示，尽管开发者认为这些API使用难度大，但是他们依旧坚信能够正确使用这些API。
但是，加密算法相关API误用却普遍存在~\cite{13-ccs-misuse}。

Robillard~\cite{11-ese-learning}从使用者的角度对API的使用进行调研。
通过多阶段的调研问卷与面对面的对面，
该研究发现开发者认为API学习难度大。
其主要原因是现有的文档形式难以有效地帮助使用者正确使用API。
特别地，缺少足够的使用样例是文档最大的不足。
因此，虽然API的设计者提供了格式良好的文档，
开发者多利用网络资源以快速的掌握API的使用情况。
这也对缺陷检测后的结果展示提出要求。

现有的接口使用调研工作多针对面向对象编程语言展开~\cite{16-icse-cry,17-tse-survey, 12-fse-parallel,12-fse-deprecation}，
因此其结果难以直接应用于C程序。
针对与接口误用缺陷，Okur对并行化API的缺陷形式进行分析、
Nadi对加密算法相关的API使用情况进行分析。
这些方法都只针对于某一个特性，其结果难以直接适用于普适性接口缺陷模式。


\paragraph{规约描述语言}
软件行为规约（behavorial specification）是对软件系统或者组件预期行为的精确描述。
独立的代码实现并不能很好地描述其意图，
所以规范记录下来的信息对于软件维护有着重要的作用，
能够有效的记录API开发者和使用者之间的协议~\cite{92-ieee-contract}。
特别地，形式化的规约描述语言能够消除自然语言的歧义。
规约能够在软件的整个开发周期使用。
一方面，开发人员可以根据规约进行研发内部功能。
另一方面，测试人员能够在调试的阶段根据规范去分离错误和划分责任~\cite{05-vstte-spec}。
近三十年来，研究人员针对不同的语言和目标，设计了各种各样的BISL~\cite{survey12}。
例如，针对通用属性检测的BLAST~\cite{blast}、ACSL~\cite{acsl}，
针对SSL安全的SSLINT~\cite{15-sp-sslint}、Windows内核驱动程序的SLIC~\cite{01-slic}、异常处理检测~\cite{16-sec-epex}等等。


BLAST~\cite{blast}由Dirk Beyer教授提出，用于BLAST自动化验证工具，面向时序安全属性的规约描述语言。
该语言从两个不同的精度水平对程序的属性进行描述。
微观来说，该语言能够通过描述检测自动机（monitor automata）的内部转移，
以在程序的运行时刻轨迹上对程序时序属性进行分析。
宏观来讲，该语言通过撰写可达性查询语句，
对程序的状态与位置进行查询。
通过两个精度水平的描述，能够有效的将验证问题转化到多个独立的模型检测引擎中，
以降低验证工作的复杂性。

ACSL（ANSI/ISO C Specification Language）是Frama-C~\cite{16-rv-framac}代码分析平台用来形式化定义C程序属性的规约描述语言。
该语言通过注释的方式对程序中属性进行描述，以辅助验证工具对代码的实现进行检测。
ACSL注重函数合约（function contract），
即函数的参数与函数执行后需要满足的性质。
其中，前者也被称作前置条件（pre-condition）；后者被称作后置条件（post-condition）。
特别地，前置条件多针对于API使用者，即在调用目标API之前需要满足的约束。
ACSL以代码注释的形式撰写，因此，为了利用ACSL，
验证工具需要理解ACSL的语义，同时将ACSL与目标C程序的源代码进行转化。


针对C程序接口使用规约，现有的规约描述语言存在若干不足。
一方面，通用语言针对多种程序属性设计，语法结构多样，语义丰富。
这种特点有利于描述接口的实现。
接口使用多含有复杂的程序结构，设计多个API的协同使用。
因此通用语言描述使用规约复杂。
另一方面，现有的领域特定的规约描述语言多针对某个接口使用特性，
难以扩展到普适性的接口使用规则。
例如SLIC语言能够有效的应用于Windows操作系统的驱动程序，
却难以应用于SSL安全裤中的API。


特殊应用语言

API-misuse bug study(18P34)

compsac19

\section{接口缺陷分类}
\label{sec:2.3}
(compsac19)
\subsection{数据收集}
\subsection{分类结果}
\subsection{讨论}

\section{规约描述语言}
\label{sec:2.4}
\subsection{设计动机}
\subsection{语法}
\subsection{语义}
\subsection{应用案例}


\section{本章小结}
\label{sec:2.5}
本章对