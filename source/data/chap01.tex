\chapter{绪论}
\label{cha:intro}

\section{研究背景}
在过去的二十年里，软件在我们的日常生活中无处不在。
每一天，新开发的软件服务为我们带来独特的生活视野，使我们的生活更加便捷与高效。
同时，软件开发为经济发展带来了巨大贡献。
据非盈利国际软件研究组织Software.org~\cite{software-org}评估，软件行业为美国2016年国内生产总值贡献超过1.14万亿美元，提供就业岗位超过1050万人。与过去两年相比，平均增长6.5\%~\cite{2017-eco-report}。
在我国，2017年软件和信息技术服务业发展迅速，收入到达5.5万亿元，同比增长14.2\%，对全国发展指数增长贡献率为58.7\%~\cite{2018-china-report}。


如此庞大的软件产业建立在不断增长的软件产品基础之上。因此需要软件开发公司持续的快速研发，以减少每种新产品的上市时间。
例如通过采用持续部署技术，Facebook公司每天发布的新产品数量能够达到100，甚至1000次~\cite{16-icse-continuous}。
与此同时，随着软件需求的增加，当今的软件系统越来越复杂。
为能够匹配市场需求的开发速度，至关重要的一点就是对软件组件的重用~\cite{2011-icsr-reuse, 2013-cbse-reuse}，即软件库。
这些库为现代软件提供了构建块产品，重用它们可以让开发人员站在巨人的肩膀上，专注于创新，而不是重塑基本模块。
更具体地说，这些软件库通常提供应用程序编程接口（API）以供开发者来快速构建软件系统。


软件开发者在使用这些API时，需要掌握这些接口的语义和约束条件以正确使用这些编程接口，完成目标任务。
一个API使用（API usage）是一段使用某个或某些API来完成特定功能的代码片段。
通常是一些基本程序元素（program element）的组或。
例如：函数调用，条件判断，算数运算等等。
这些程序元素的组合需要满足目标API的使用规约（usage constraint），
例如：对目标API参数的检查、API调用顺序关系和异常处理等等。
这些使用规约则和API自身属性相关。
当一个API使用违反了规约中的一个或多个时，我们称为不正确的API使用，即API误用（API misuse）~\cite{16-msr-mubench}。
API误用，已成为导致软件缺陷、崩溃，甚至漏洞的重要原因之一~\cite{12-ccs-android,12-ccs-ssl,13-ccs-misuse,13-tse-missing-call,14-apsys-case,15-icpc-api,16-ase-spec}。


例如图~\ref{fig:1-1-example}展示了漏洞CVE-2015-0288~\cite{CVE-2015-0288}的代码片段。
OpenSSL~\cite{openssl}是广泛应用的安全通信软件库。
该库将加密套接字协议层（SSL）~\cite{ssl}中的通信协议和加密算法封装在API中，以方便客户端开发者使用。
开发者在使用OpenSSL提供的API时，需要对各种证书（Certificate）进行有效性验证，以确保信息的安全性和有效性。
比如，函数\texttt{X509\_to\_X509\_REQ()}用于解码证书，当发生错误是，其返回NULL作为错误代码。
因此当开发者忽略该检查时，则会导致一个空指针引用错误（图中第9行所示）。
攻击者可以通过构造非法的证书，利用该漏洞进行拒绝服务攻击（Denial of Service），造成目标系统崩溃。



\input{data/code/style}
\input{data/code/cp1-example}


为帮助使用者理解库函数的作用和使用约束，设计人员通过各种方式提供提供高质量的文档以及应用案例共使用者参考。
然而这些辅助材料在现有的开发环境下，并没有有效的帮助开发者理解这些约束~\cite{09-icse-doc}。
更严重的是，随着开源软件的蓬勃发展，大量的库函数没有完整的文档资料，甚至没有或者存在错误的使用说明~\cite{15-ieee-doc-fail, 17-icse-api-doc}。
此外，当遇到API使用问题时，开发者更喜欢直接在搜索引擎或者问答论坛Stack-Overflow~\cite{stackoverflow}中进行查询，而不是查看官方使用说明。
不幸的是，这些问答论坛中存在大量的错误~\cite{16-sp-stack}。
研究表明，如何正确使用API是阻碍开发者开发的重要瓶颈之一~\cite{16-icse-cry}。


因此，研究人员采用更加主动的方式协助开发者正确使用API，即软件工程推荐系统（RSSE）~\cite{10-ieee-rsse}。
该方法的核心是，在软件工程任务上下文中，自动获得重要的信息并提供给开发者，以提高开发者的开发效率。
一方面，通过相似代码检索~\cite{05-icse-rec,16-icse-doc-stack,14-msr-stack}提供API使用样例，或者通过自动补全技术辅助使用者进行开发~\cite{15-tosem-code-cplt}。
另一方面，研究人员通过自动化的分析方法对已有代码进行缺陷检测，推荐潜在的API误用缺陷，以提高代码质量。


在过去的十几年中，大量的研究成果被成功应用于自动化API缺陷检测~\cite{15-coufless-static-survey,18-icse-saful,survey18}。
特别地，静态分析技术只需要源代码，可以在开发的早期进行而获得了广泛关注~\cite{05-icse-static}。
尽管在API误用检测方面，研究人员投入了大量的工作，API误用在实际项目中依旧普遍存在~\cite{16-ase-spec, 18-icse-stack}。
一项对Google应用商店的调研显示，在11748个安卓应用中，10327个超过88\%的被测对象存在至少一个加密相关的API误用~\cite{13-ccs-misuse}。
特别地，富有经验的开发者的代码中~\cite{18-soups-api-blind}，甚至对缺陷修复的代码中，同样会出现API误用缺陷。
例如，OpenSSL的开发在创建了缺陷补丁（sha: 1c4221）以``修复crl2pkcs7 app中存在的内存泄漏缺陷''。
然而该补丁忽略上下文路径关系，导致在某些可达路径上对``内存重复释放''。
该缺陷被新的补丁（sha: d285b5）修复，修复的日志为``在crl2pl7中避免重复释放缺陷''。


随着软件库函数数量增加、软件规模增长与代码复杂度提高、开源代码广泛应用，现有的API误用缺陷检测方法面临巨大挑战。
一方面，缺陷检测需要具有较强检测能力，即尽可能多地检测出代码库中的实际缺陷。
另一方面，缺陷检测需要具有较高精度。如果一个检测工具具有大量误报，即缺陷报告中的缺陷并不是实际缺陷，开发者将会摒弃这些工具~\cite{10-acm-precision}。
同时，对于检测结果，为开发者提供有效的缺陷展示形式，提高开发者对缺陷修复效率也是促进检测工具应用的重要因素之一~\cite{13-icse-donotuse}。
因此，如何设计有效的API缺陷静态检测技术，以应对大规模复杂代码，为开发人员提供高精度、低漏报的缺陷检测服务，并能够辅助开发者理解缺陷提高修复效率，是目前工业界迫切需求，也是学术界的研究热点。

%本章将介绍C程序接口缺陷的概念，总结C程序接口缺陷的关键问题与研究现状，说明研究思路与主要贡献。

%API广泛(18P17)

%什么是API误用(18P27)

%API检测难点(18P25)

\section{研究现状}
围绕程序的接口误用缺陷检测技术有3大类技术路线：代码审查、动态程序检测和静态程序检测技术。
代码审查技术旨在通过软件同行协同走查代码的方式，人工的找出与修正代码中的缺陷以及编码规范。
动检检测技术与静态检测技术相对，前者通过将程序执行以发现缺陷，后者则不需要执行程序。
下面将通过这三个方面对API误用缺陷检测相关的现有研究进行总结。

\subsection{代码审查}
代码审查（Code Review）是指开发人员通过系统地阅读程序源代码的API使用情况，以找出即修正在开发初期未发现的错误，提升软件质量的活动~\cite{code-review}。
随着版本控制管理工具和开源社区的发展，通过在线软件库（例如Github~\cite{github}和Bitbucket~\cite{bitbucket}）可以允许开发者远程协同审查代码，简化了代码审查的代价。
一项调研显示，在对于240个一线开发者的调研中，超过90\%的开发者所在的公司在使用代码审查技术以提高代码质量~\cite{17-profes-code-review}。
通过开发者协同走查代码，能够有效的找到程序中的缺陷、维持代码统一的编程风格以增加可维护性、有效的分享领域知识与协调开发进度~\cite{13-icse-code-review}。
特别地，在2008年对超过12000实际项目开发流程的调研中显示，代码审查的缺陷发现率高达60-65\%~\cite{08-code-review}。

然而，代码审查活动需要大量的人工操作，是代码开发流程中占用时间最多的活动之一~\cite{13-esem-code-review}。
大量的人力和时间成本使得代码审查收到越来越多的质疑。
其中微软公司2015的调研结果显示，代码审查严重的阻碍了开发的进度。
在所有的代码审查结果中中，只有15\%的内容与缺陷查找有关~\cite{15-icse-code-review}。
与此同时，随着代码量的增大，代码审查的效率降低，需要开发者具备更好的领域知识。
这些因素都制约了代码审查在当代软件开发环境中的效果。


\subsection{动态检测}
动态程序检测技术（Dynamic Program Analysis）是程序分析技术的一种~\cite{15-pa}，通过程序的运行时行为检测程序的缺陷。
动态程序检测技术在程序运行时，对程序的内部逻辑以及功能进行缺陷检测。
因此检测结果的正确率可以达到100\%，即没有误报。
针对接口使用缺陷检测，典型的动态检测技术是集成测试（Integration Testing）~\cite{02-icis-integration-testing}。
该方法对已经通过测试的底层API实现模块组合后的代码进行测试，以检测API在组合时使用中的缺陷。
通过构造输入和输出，动态的执行模块以检测程序中API使用的正确性。
近年来，动态验证技术（Runtime Verification）获得广泛的应用~\cite{18-rv}。
动态验证技术从传统的验证技术发展而来，旨在运行时对程序的状态进行监控，以查看程序是否满足预定的属性。
从技术方案上来说，需要进行两个步骤：插桩与日志分析~\cite{07-acm-valgrind, 91-purify, 12-atc-AddressSanitizer}。
插桩通过对源代码或者二进制代码进行语句或者指令的改写，以在运行时输出或者获得程序的状态。
基于获得的程序状态和日记，通过分析技术对程序的运行状态进行查找。
当程序崩溃或者违反预先定义的程序属性时，则找到缺陷。
例如：AddressSanitizer~\cite{12-atc-AddressSanitizer}是由谷歌公司开发的针对内存缺陷检测的工具。
该工具已经集成在Clang~\cite{clang}和GCC~\cite{gcc}编译器，与Xcode~\cite{Xcode}开发环境中，找到了数百个实际缺陷~\cite{AddressSanitizerFoundBugs}。


动态检测技术具有高精度、跨函数的特点。能够找到跨越多个函数、复杂的API误用缺陷。同时，其复杂度与程序的规模呈线性关系，即运行时间不会随着程序规模变化而产生巨大开销。
然而，针对于接口误用缺陷检测，该方法面临如下不足：
（1）程序覆盖率问题。
动态检测技术对程序的运行时状态进行捕获和分析。
模糊测试技术（Fuzzy Testing）~\cite{18-fuzz}通过自动的构造随机的输入，能够有效的增加检测的覆盖率，并成功应用于工业界~\cite{18-saner-fuzz}。
然而，在分析过程中依旧只能覆盖程序执行的部分，难以保证所有的程序路径。
（2）测试构造与插桩技术。一方面，为了能够尽可能多的覆盖程序的分支情况，测试人员需要构造大量的测试用例。
然而，这需要对程序的语义具有深刻的理解与大量的时间。
另一方面茶庄技术面临不同的程序结构与编译器的优化策略，可能失效。同时，修改后的程序运行效率受到影响。
（3）测试环境。
与API实现的测试不同，API使用包含多个程序元素、复杂的逻辑关系以及项目特定的约束条件。
同时，部分API误用缺陷发生在特定的物理环境下~\cite{15-kernel-sv}。
例如：对于硬件检测的异常处理API，需要在特定的环境下才会触发。
这些测试环境的准备需要大量的人力财力。

\subsection{静态检测}
静态检测技术（Static Program Analysis）~\cite{08-ieee-static}与动态检测技术相对，在不执行程序的情况下对程序中缺陷进行检测。
针对于接口误用缺陷检测，静态检测技术有三类常用方法：
验证技术、静态分析技术和数据挖掘技术。

\paragraph{验证技术}
程序验证技术通过遍历程序的所有可能状态以证明程序的正确性或给出反例~\cite{08-tcad-sv}。
针对于接口误用缺陷检测，静态程序验证技术本身难以直接对缺陷进行检测，需要将检测问题转化为可达性问题~\cite{rp}。
检测工具需要提供或内部集成相应API正确使用的规约条件，并将规约条件与程序状态相对应。
当发现到达违反规约条件的程序状态时，则认为检测到API误用缺陷。

最具代表的接口缺陷验证工具是微软公司的SLAM项目~\cite{slam}。
SLAM项目成立于2001年，旨在检测软件接口使用行为是否满足约束条件，以辅助开发者正确的使用接口的功能。
开发者通过使用SLIC规约描述语言~\cite{01-slic}对程序接口的属性进行描述，并使用Static Driver Verifier（SDV）~\cite{02-acm-slam}工具对目标API进行检查。
SDV通过对源代码的进行解析并根据SLIC规约对代码进行插桩，并利用反例引导的抽象解释技术（CounterExample-Guided Abstraction Refinement）~\cite{00-cav-counter,02-acm-abs}对API误用缺陷进行查找。
至2010年，该项目已经积累200余API使用规约，成功检测Windows操作系统的驱动程序中270个API误用缺陷，有效的提高了接口使用的正确性~\cite{10-cad-slam, 11-acm-slam}。
Avinux~\cite{09-avinux}静态验证工具集针对操作系统内核，扩展了SLIC描述语言。
该工具利用能够对单个预处理的源代码文件进行缺陷检测。
此外，针对操作系统的驱动程序，DDVerify~\cite{07-ase-ddverify}针对操作系统的驱动程序进行了场景建模，并对其中的四种场景进行验证。
其他的通用验证工具也能够支持部分API误用缺陷类型，例如
CPAchecker~\cite{07-cav-cpachecker}、CBMC~\cite{14-tacas-cbmc}、SMACK~\cite{14-cav-smack}等。


尽管程序验证技术能够检测API误用缺陷，其面临如下不足。
（1）规约描述语言（Behavior Specification）能够有效的描述接口使用的约束条件。
然而，现有的描述语言多针对接口的功能实现~\cite{blast, acsl}。
虽然SLIC是针对接口使用设计，但是该语言针对于Windows驱动程序设计，难以应用于普适性的接口误用缺陷检测。
同时该语言使用复杂，需要较强的理解以设计相应的规约条件。
（2）尽管验证技术能够实现可靠甚至完备的程序正确性分析，然而该技术的可延展性难以满足现实开发者的需求。
目前，状态空间爆炸问题（state space explosion problem）是验证技术难以应用的最重要的挑战之一。

\paragraph{静态分析技术}
静态分析技术与验证技术不同，其目标在于通过强大且灵活可控的抽象方法能够实现对大规模
软件代码的高效分析，以完成对源代码中的缺陷检测。
该技术能够在开发的早期使用，有效的降低缺陷检测和修复的成本~\cite{06-cost}。
因此，近年来，静态分析技术成为了代码质量保证的有效途径之一，并被广泛使用。
静态分析工具在代码的编译时或基于编译后的中间表达（intermediate representation），利用预先定义好的规则或者程序语义信息对接口误用缺陷进行检测。
即，在程序中是否能够发现某些代码违反了正确的编程规则。
例如，是否在API的参数是否为空~\cite{00-osdi-npd},内存操作API是否存在越界~\cite{11-ras-overflow},Linux内核API是否使用正确~\cite{09-dsn-linux}等等。

近二十年来，研究人员和开发者设计并实现了大量的开源静态分析工具~\cite{wiki-static-tool}。
支持接口误用缺陷检测的代表性的工具包括：Clang Static Analyzer（Clang-SA）~\cite{clang-sa}， Cppcheck~\cite{cppcheck}，Infer~\cite{infer}，Sparse~\cite{sparse}，Splint~\cite{splint}，SSLINT~\cite{15-sp-sslint}等等。
Clang Static Analyzer（Clang-SA）~\cite{clang-sa}是开源编译器框架LLVM~\cite{llvm}的重要模块之一，能够独立的运行。
该工具利用符号执行技术（Symbolic Execution）~\cite{13-acm-se}推理程序的语义信息，并通过检测插件的形式对程序中的缺陷进行检测。
Cppcheck~\cite{cppcheck}工具将代码预处理为符号（token）流，并在符号流中通过模式匹配的方法，进行缺陷检测。
为了支持用户自定义的API，Cppcheck提供一套轻量级的规约描述方法，以供使用者撰写规约。
与上述两种通用缺陷静态分析工具不同，
Facebook公司的Infer工具关注内存安全，Sparse和Splint工具针对Linux操作系统设计，SSLINT则通过对SSL协议建模以对安全相关API误用进行缺陷检测。


为了能够支持大规模、多领域、快速检测的需求，静态分析技术一方面将规则编码在分析引擎或者检测器（checker）中，另一方面采用抽象的方法以简化程序接口。
因此针对于大规模复杂的API误用缺陷检测，其面临如下不足。
（1）缺陷模式硬编码，对用户自定义API支持不足。
例如，Clang-SA提供大量的检测器，其对用户自定义API支持有限。同时，该工具缺少轻量级的接口以供使用者开发新的检测器。
虽然Cppcheck提供的规约描述方法能够有效的缓解用户自定义接口缺陷检测困难。然而其语义简单，难以应对复杂的接口误用缺陷模式。
（2）误报漏报难以满足用户实际要求。
为了能够给使用者提供好的用户体验，静态分析工具往往采取保守策略，即只报告高可能性的缺陷。
因此，大量的实际缺陷被漏报。
如果提高报告率，则产生大量的误报。
（3）针对接口误用缺陷分析精度不足。
API使用多包含复杂的语义上下文信息，甚至跨越多层函数调用。
同时，针对不同的路径条件，API使用的情况不同。
现有的静态分析工具多基于语法级别、忽略路径信息、过程内（intra-procedural）的分析技术以应对大规模快速分析的需求。
因此，会产生大量的漏报以及误报。

\paragraph{数据挖掘技术}
为了弥补传统静态程序分析技术规约撰写困难、难以支持用户自定义接口的不足，近年来，研究人员通过基于数据驱动的挖掘技术来自动推理API使用规约~\cite{13survey}。
这些技术的核心思想为在大规模代码库中，出现次数多的使用形式为为正确的模式，出现次数少的则为误用。
即，首先通过挖掘技术学习程序中的API使用的规约，后通过这些规约进行异常检测。
随着开源代码（例如Github）与代码挖掘平台（例如：BOA平台~\cite{15-tosem-boa}）的蓬勃发展，大量的工作被投入到规约挖掘的技术与工具研究中，并成功应用于实际项目中~\cite{survey18}

基于数据挖掘规约推理技术最早由Engler等于2001年提出~\cite{01-sosp-mining}。
改论文通过用户自定义的规则模板，在代码中自动推理API使用约束。
例如，函数\texttt{A}必须与函数\texttt{B}成对出现。
此后，Li等基于频繁项目挖掘技术（frequent itemset mining）~\cite{03-fimi-frequent}，设计并开发了全自动的规约挖掘工具PR-Miner~\cite{05-fse-prminer}，有效的提高了该方法的精度，增加了支持的缺陷模式种类。
此后，研究人员不断地设计并实现新的推理技术以支持更多的规约模式。
例如，带有条件的因果调用关系（causal relationship）~\cite{07-fse-temporal}，调用序列~\cite{09-ase-sequence}，接口调用前置条件~\cite{14-fse-pre}，异常处理~\cite{16-ase-apex}等等。
总结来说，这些方法的不同在于如何对源代码进行标准化表示、如何统计API使用的次数与上下文关系、如何通过学习的规约条件进行缺陷检测。

尽管规约挖掘技术能够自动化的学习API使用的规约，同时基于规约进行误用缺陷检测，这些方法在实际应用中经常产生大量误报与漏报。其主要原因包括：
（1）难以获得足够的训练数据。
基于数据驱动的学习技术需要大量的有效数据以学习正确的规约条件。
然而在单个项目中，特别是用户自定义的API，难以满足数据量的需求~\cite{15-kernel-sv,survey18}。
（2）无关语句影响学习结果。
现有的学习技术多基于语法层表示，缺失的语义信息导致学习过程中无关语句对结果影响巨大~\cite{16-icse-antminer}。
（3）无法学习隐式规约条件。
基于学习的方法只能够学习显式的规约条件，而对于C程序无法显示的表示的条件则无法学习，因为程序中无法表达这样的内容。
例如：C标准库的\texttt{free}函数不可以释放非堆内存，不然会导致一个释放非堆内存（CWE-590：free of memory not on the heap）错误。


\section{研究思路}
整体思路图（cxP13）

本文的研究思路具体如下：

1.

2.

3.



\section{论文贡献}
本文根据上述研究思路，针对C程序接口缺陷的静态检测技术进行了系统性研究，取得了相应的理论效果，实现了对应的工具软件集合。论文的具体贡献如下：

1. 为XXX，做了XXX。

2.

3.
\section{论文结构}
本文共包括5个章节。第2章介绍针对接口使用的规约描述语言，包括基于实际案例的接口缺陷分类以及规约描述语言的设计思路、语言和语义。
第3章讨论接口缺陷的静态检测技术。
第4章介绍接口缺陷检测工具集合与开源项目的应用。
最后第5章总结全文并展望延伸本文工作的若干方向。
