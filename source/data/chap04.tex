\chapter{接口缺陷检测工具集与应用}
\label{cha:tools}
在代码质量保障中，规约描述语言能够有效的描述接口使用的约束体检、
高效的检测算法能够对大规模程序进行缺陷检测。
然而，这些已有成果离不开面向实际应用场景的工具集的支持。
直观地说，工具决定了语言描述、缺陷检测等成果在实际中的应用效果。
本文将第\ref{cha:impsec}章和\ref{cha:imchecker}章的研究成果应用于实际项目中，
并将结果总结在本章中。
具体来说，本章包含两部分内容：C程序接口缺陷数据集APIMU4C和
可视化支持的C程序接口缺陷检测工具集Tsmart-IMChecker。
APIMU4C包含对开源项目调研中找到的接口误用缺陷实例，
以及针对C程序的接口缺陷测试集。
Tsmart-IMChecker工具集包含三个子工具，
以帮助使用者方便高效地撰写IMSpec规约、执行分析引擎、基于差异性对比的分析检测结果。
同时，本章将Tsmart-IMChecker工具集应用于实际开源项目中，并对应用结果进行总结。
从全文的研究体系上看，
本章的工作旨在将接口描述语言IMSpec和规模化检测方法IMChecker应用于实际项目中，
体现前两章研究成果的实用性。

\section{引言}
过去的十几年内，研究人员与开发人员针对于C程序接口缺陷检测的工具设计和实现方面投入大量的时间和努力，
取得较好的研究成果。
例如，微软公司著名的接口缺陷检测项目SLAM，
被广泛使用的开源静态分析工具Cppcheck和Clang Static Analyzer等等。
特别地，为了给使用者提供更好的用户体验，这些工具都提供了良好的工具接口。
或通过命令行的方式直接调用工具进行检测，或者提供可视化支撑的GUI工具。
然而，针对于当下的开发环境和程序特点，以上方法存在若干不足。
为了弥补现有工作的不足，本文在第\ref{cha:impsec}章和\ref{cha:imchecker}章分别提出了基于缺陷模式的接口使用约束的领域特定语言IMSpec，
以及基于规约描述的规模化接口缺陷检测方法IMChecker。
本章将这两部分研究内容进行整理和封装，应用于实际开源项目中，并对应用结果进行总结。

首先，为了帮助研究人员和开发者更好的理解接口误用缺陷，
本章将缺陷调研以及算法评估中的原始数据集合进行整理和封装，
形成C程序接口缺陷数据集APIMU4C。
APIMU4C包含三个模块，即：
（1）面向Git版本控制库的修改记录挖掘工具Gitgrabber，
（2）开源项目接口缺陷案例库，
（3）基于公开数据集合以及实际项目的接口缺陷测试数据集。
APIMU4C包含本文中所有的原始数据集，
同时研究人员和开发者可以利用Gitgrabbger对其他领域的缺陷修复进行挖掘和提取。
此外，接口缺陷测试数据集能够帮助研究人员和开发者对现有工具进行评估，
以设计更具针对性的检测算法和选择适用的工具进行特定种类的缺陷检测。


为了提高工具的实用性，减轻使用者的负担，现有工具都提供良好的用户接口。
每个工具都有自己的特定，所针对的对象亦不同。
针对IMSpec语言和IMChecker检测方法，本文开发了相关的图形化支撑工具集Tsmart-IMChecker，
以提供更好的用户体验。
本工具集共包含三个主要模块，即：
（1）图形化规约撰写工具IMSpec-writer，通过点击、选择和填入必要语义信息的的方式，辅助开发者撰写规约；
（2）静态分析引擎IMChecker，通过对IMChecker方法的实现和封装，帮助开发者通过命令行的方式，直接调用分析引擎并生成对应的缺陷分析报告；
（3）图形化结果展示工具IMDisplayer，通过差异性结果展示的方式，帮助使用者快速、准确的定位缺陷。
本章将Tsmart-IMChecker应用于实际开源项目中，以检测工具的使用性。
工具集在Linux内核、OpenSSL和Ubuntu的应用软件的最新稳定版本中，
共发现75个实际缺陷。
作者将缺陷报告提交给相应开发者确认。
其中，62个已经被开发者确认，32个已经在主分支中修复。
本章中对实际应用中的困难和发现进行总结，以帮助研究人员和开发者设计更好的检测工具。



本章其余部分组织结构如下：
\ref{sec:4.2}节对APIMU4C数据集进行介绍；
\ref{sec:4.3}节介绍Tsmart-IMChecker工具总体架构和各子工具；
\ref{sec:4.4}节给出工具集在开源项目上的应用结果；
最后在\ref{sec:4.5}节总结本章工作。

\section{C程序接口误用数据集}
\label{sec:4.2}
近年来，软件缺陷获得了研究人员的广泛关注。
特别地，为了有效的比较缺陷检测工具的性能，
研究人员整理了针对不同领域和不同目的的数据。
例如，BugBench~\cite{05-bugbench}是针对C程序的缺陷评估集合，
共包含17个开源项目中的缺陷实例，
其中13个与内存、并发和语义相关。
Defects4J~\cite{14-issta-defects4j}是面向Java程序的缺陷集合，
共包含来自5个开源项目的357个缺陷实例。
在2016年，Amann等整理了MUBENCH~\cite{16-msr-mubench}数据集。
该数据集包含89个Java语言实际项目中的接口误用缺陷。
为了能够帮助研究人员和开发者更深入的理解接口误用缺陷，
本章整理了C程序接口误用数据集APIMU4C。
该数据集包含三个部分，面向Git版本控制库的修改记录挖掘工具Gitgrabber、
开源项目接口缺陷案例库、
以及基于公开数据集合以及实际项目的接口缺陷测试数据集。
本节将对每一个部分进行详细介绍，

\paragraph{Gitgrabber}
对于实际缺陷的分析有利于对缺陷本质的理解。
所以，无论是规约描述语言还是检测算法的设计，获得实际缺陷实例是重要基础。
随着软件复杂度增加和软件规模提升，现代软件难以独立完成。
同时随着网络的发展，越来越多的开发团队远程办公。
在众多的代码维护方式中，Git版本控制软件是最为广泛使用和最受欢迎的方式。
如图~\ref{fig:2-3-description}所示，开发者在使用Git版本控制软件时，
对于每一次修改记录，都会提供修改的描述报告。
Git会自动计算修改记录中代码的差异，生成差异报告。
因此，本文作者设计了Gitgrabber，面向Git版本控制软件的修改记录挖掘工具。
该工具基于Python语言设计，通过自然语言处理的方式对修改记录挖掘。
Gitgrabber需要用户提供配置文件，以提供挖掘的项目分支、关键词、
时间区间、个数、文件行数。
同时，Gitgrabber提供了多层挖掘服务，即在第一层挖掘结果的内容中，进行二次检索。
例如，通过缺陷修复的关键词进行缺陷修复相关修改记录挖掘。
再基于某种特定类型的关键词，挖掘特定领域的缺陷修复。
Gitgrabber使用方便，只需要提供基于结构化的描述的配置文件，并通过如下命令执行，
\begin{lstlisting}[language={bash},
basicstyle=\linespread{0.8}\listingsfont,
numbers=none,
xleftmargin=.3\textwidth]
(*@\textcolor{blue}{python}@*) main.py --config config.yml
\end{lstlisting}
挖掘的结果包括：修改记录报告、差异性报告、修改前文件和修改后的文件。
本文中缺陷模式调研的缺陷实例均来自于Gitgrabber的结果。

\paragraph{接口缺陷案例库}
理解缺陷模式是设计缺陷检测工具的重要基础。
所以，对实际项目中的缺陷进行分析，有利于研究人员和开发者更深入的理解缺陷的本质。
因此，本文作者将第~\ref{cha:impsec}章第~\ref{sec:2.3}节中分析的接口缺陷实例进行总结，
形成接口缺陷案例库。
目前该案例库共包含来自6个项目的830个实际接口误用缺陷实例，
其中Linux内核283个、OpenSSL127个、FFmpeg126个、Curl134个、FreeRDP119个以及Httpd41个。
作者对830个缺陷进行深入分析，以确保这些实例与接口误用相关。
同时，针对于每一个缺陷实例，我们收录了缺陷修复报告、差异性报告、修改前错误版本源文件以及
修改后正确版本源文件。
研究人员和开发者可以对这些案例进行研究，以设计更具有针对性的缺陷描述方法和检测方法。

\paragraph{接口缺陷测试集}
标准化的缺陷测试集合能有有效评估缺陷检测工具。
然而，目标并没有针对C程序接口误用缺陷的公开测试集合。
因此，作者基于公开数据集以及实际项目中的缺陷，构造了C程序接口缺陷数据集。
该数据集构成如表~\ref{tab:4-2-dataset}所示。
其中2172个为人工构造的单文件测试用例。
这些测试用例来源于广泛使用的公开测试集Juliet Test Suite和ITC~\cite{itc}。
每个测试用例在100-200行之间，涵盖不同的C语言的语法结构。
可以用来对检测工具的的语言支持度和检测策略进行分析。
测试集的另一部分为实际项目缺陷。
这些缺陷来源于缺陷调研的结果，并注入到项目的最新版本中。
可以用来评估检测工具在实际项目上的分析能力和效果。
这2272个缺陷集合包含了缺陷调研中常见的三种缺陷模式。
C程序接口缺陷数据集一方面能够帮助研究人员设计更具有针对性的检测算法。
另一方面，可以对现有工具进行评估，帮助研究人员分析现有工具不足。
同时使用者可以通过检测结果对工具的能力进行评估，以选择更使用的工具。

\input{data/tab/4-2-dataset}
\section{工具集组成}
\label{sec:4.3}
软件可信保障工具集Tsmart (Trustworthy Software System Modelling And Verification Toolkit)，是清华大学软件学院软件系统与工程研究所研发的软件系统建模验证工具集。
Tsmart~\cite{tsmart}工具集在2019年1月发布第三版，是具有完全自主知识产权，面向软件代码安全可靠性的多维度保障体系。
Tsmart具有代码合规性分析、缺陷静态检测、缺陷自动修复、并发性属性分析等功能。
工具集可用于自动化地检测软件系统中难以发现、调试的重要缺陷，并给出相应的修复建议，从而提高软件系统的可靠性，以及软件开发测试效率，减小因为软件缺陷导致的损失。
Tsmart-IMChecker工具集是Tsmart的重要组成部分，面向C程序接口使用缺陷设计。
本节将对Tsmart-IMChecker的总体架构、模块组成进行介绍。

\subsection{总体架构}
Tsmart-IMChecker是基于可视化支持的C程序接口缺陷检测工具集。
如图~\ref{fig:4-3-overview}中所示，
工具集包含三个主要模块：
\begin{enumerate}
	\item IMSpec规约撰写工具：IMSpec语言提供了一套轻量级、类标记语言的语法结构，
	然而，手动撰写规约是一件耗时、容易出错的工作。因此本文设计了可视化支撑的IMSpec规约撰写工具，
	帮助用户描述接口使用约束。
	\item IMChecker分析引擎：本文将规模化检测方法实现于IMChecker分析引擎中，
	并提供基于命令行的使用接口。用户可以直接调用该接口进行缺陷检测，
	也可以将分析引擎嵌入到实际开发环境中，作为第三方插件使用。
	\item IMDisplayer结果展示工具。Tsmart工具集提供了基于网页版的可视化结果展示工具。
	为了帮助实际用户更好的理解接口使用缺陷发生原因，本文实现了基于差异性的结果展示工具。
	通过在同一个项目中，正确使用实例与缺陷实例的对比，突出接口误用的缺陷原因。
\end{enumerate}

\begin{figure}[t]
	\centering
	\includegraphics[width=0.85\linewidth]{figures/cp4-overview.png}
	\caption{
		Tsmart-IMChecker工具集使用流程。
	}
	\label{fig:4-3-overview}
\end{figure}

用户使用Tsmart-IMChecker工具进行接口缺陷检测需要三个步骤，即
（1）撰写规约，（2）缺陷检测，（3）结果确认。
首先，开发者通过IMSpec规约撰写工具，对目标接口的使用约束进行描述。
如果开发者理解IMSpec的语法结构，也可以通过直接撰写文本格式的规约描述。
在第二步，开发者通过调用缺陷检测引擎，基于提供的规约描述对源代码进行分析。
最后开发者可以直接通过生成的报告进行缺陷检测结果的核对，
也可以通过可视化的IMDisplayer工具对检测结果进行确认。
本节将在剩下的内容中，对每个模块进行详细介绍。



\subsection{规约撰写模块}
接口使用约束作为接口规约的一部分，已经被证明能能够有效的应用于软件工程领域的不同任务中。
特别地，这些规约能够帮助开发者理解如何正确使用API，
以及帮助测试人员对接口误用缺陷进行检测。
然而人工撰写这些约束条件需要大量的时间与经历，
同时容易在撰写中产生语法错误。
为了使用者减轻撰写IMSpec约束的负担、提高撰写规约语法的准确性，
本文设计并实现了图形化支撑的IMSpec规约撰写工具。

如图~\ref{fig:4-3-IMSpec-writer}中所示，IMSpec规约撰写工具包含三个部分：
\begin{itemize}
	\item {\kaishu 规约列表}
	界面的最左侧是规约列表，用于展示使用者已经完成的IMSpec接口约束实例。
	用户可以在列表中直观地了解已经完成的约束描述。
	\item {\kaishu 编辑区} 
	界面的右侧为规约编辑区，用于对IMSpec规约进行编辑。
	编辑区包括三大主要区域：目标对象区域、前置条件编写和后置条件编写区域。
	用户在确定目标接口的名称和参数定以后，可以在下列的Ref区域选择性的填写与目标API相关的因果调用关系函数。
	例如：目标接口时\texttt{fopen()}函数，那么用户可以在Ref区域通过填写\texttt{fclose()}函数的定义强化因果调用关系。
	后续中，用户可以根据具体的接口使用约束，对前置条件和后置条件进行编辑。
	特别地，IMSpec规约撰写工具在IMSpec语法基础之上，
	在界面显示中进行了细微的调整，以提供更直观、准确的功能。
	\item {\kaishu 文件操作区} 
\end{itemize}

用户通过命令行，执行imspec\_writer.py运行该工具：
\begin{lstlisting}[language={bash},
basicstyle=\linespread{0.8}\listingsfont,
numbers=none,
xleftmargin=.3\textwidth]
(*@\textcolor{blue}{Ubuntu@~:Python3}@*) imspec_writer.py
\end{lstlisting}
其运行结果被保存在用户选择的目录中的*.yaml文件中，
例如图~\ref{fig:2-4-example-imspec}中IMSpec实例。
此外，为了帮助使用者维持项目特定的语义及特殊定义，
IMSpec规约撰写工具提供了define.h文件共使用者定义宏参数。
例如针对于图~\ref{fig:2-4-example-imspec}中IMSpec实例，
用户可以在define.h中，定义如下宏：
\begin{lstlisting}[language={C},
basicstyle=\linespread{0.8}\listingsfont,
numbers=none,
xleftmargin=.3\textwidth]
#define SUCCESS 1
#define FILEERR -1
#define IOERR -2
\end{lstlisting}
则在后续的解析IMSpec语言时，解析会进行宏展开，以和程序中的语义保持一致。

\begin{figure}[t]
	\centering
	\includegraphics[width=0.85\linewidth]{figures/cp4-IMSpec-writer.png}
	\caption{
		IMSpec规约撰写工具截图。
	}
	\label{fig:4-3-IMSpec-writer}
\end{figure}


\subsection{缺陷检测模块}
\begin{figure}[b]
	\centering
	\includegraphics[width=0.85\linewidth]{figures/cp4-IMChecker-engine.png}
	\caption{
		IMSpec规约撰写工具截图。
	}
	\label{fig:4-3-IMChecker-engine}
\end{figure}
为什么

界面介绍

输出结果
1页
\subsection{结果展示模块}
\begin{figure}[b]
	\centering
	\includegraphics[width=0.85\linewidth]{figures/cp4-IMDisplayer.png}
	\caption{
		IMSpec规约撰写工具截图。
	}
	\label{fig:4-3-IMDisplayer}
\end{figure}
为什么

界面介绍

输出结果
1页
差异性结果展示模块

1. 规约 2. 对比。源于两方面，sec2.5被测对象认为IMSpec更有效。
实际开发者学习到的经验，即对路径和对比的需求。

\section{案例应用}
\label{sec:4.4}
\subsection{应用对象}
1页
(icse-tool)
对象

目标API

https://github.com/tomgu1991/IMChecker/tree/master/imspec

平台参数



\subsection{缺陷检测结果}
%https://github.com/tomgu1991/IMChecker/blob/master/evaluation_data/new_bugs/bug_list.md

总体结果
0.5
buglist

\paragraph{Linux内核}
2页

\paragraph{OpenSSL}
2页

\paragraph{应用程序}
2页

每类缺陷举例子
代码+回复


\subsection{开源社区反馈}
%https://github.com/tomgu1991/IMChecker/blob/master/evaluation_data/new_bugs/bug_list.md
1. 感谢
0.5页

2. 新的Bugchecker
0.5页

3. keepalive的后续
0.5页

\subsection{应用经验总结}

3页

\section{本章小结}
\label{sec:4.5}
本章将C程序接口使用约束描述语言IMSpec和规模化接口缺陷检测方法IMChecker在实际项目中进行应用。
为了帮助研究人员和开发者理解接口误用缺陷，本章整理了C程序接口缺陷数据集APIMU4C。
该数据集包含接口缺陷案例库以及接口缺陷测试集，以供检测工具的性能评估、针对性的工具选择和新的算法研究。
同时，本章设计并实现了可视化支撑的C程序接口缺陷检测工具集Tsmart-IMChecker，
并将工具集应用于开源项目缺陷检测中。
结果显示，Tsmart-IMChecker在Linux内核、OpenSSL库和Ubuntu系统应用软件的最新版本中，
共发现75个实际缺陷。其中62个已经被开发者确认，32个被开发者修复。